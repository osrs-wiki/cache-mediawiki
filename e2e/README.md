# End-to-End Tests

This directory contains end-to-end (e2e) tests for the cache-mediawiki CLI application. These tests run the actual CLI commands and validate the output against snapshot tests.

## Running E2E Tests

### Run all e2e tests

```bash
npm run test:e2e
```

### Update snapshots

When the CLI output changes intentionally, update the snapshots:

```bash
npm run test:e2e -- -u
```

### Run specific test files

```bash
npm run test:e2e -- cli.e2e.ts
npm run test:e2e -- pages.e2e.ts
```

## Test Structure

### CLI Tests (`cli.e2e.ts`)

Tests basic CLI functionality:

- Help text display
- Version information
- Parameter validation
- Error handling

### Pages Tests (`pages.e2e.ts`)

Tests the `pages` command for all supported types:

- **Item pages**: Tests item page generation and output file structure
- **NPC pages**: Tests NPC page generation
- **Area pages**: Tests area page generation
- **Scenery pages**: Tests scenery page generation

Each test validates:

1. Command exits successfully (exit code 0)
2. Expected output files are created in `./out/pages/<type>/`
3. Generated content matches snapshot tests

## Snapshot Tests

The e2e tests use Jest snapshot testing to ensure output consistency. Snapshots are stored in `e2e/__snapshots__/` and capture the exact MediaWiki content generated by the CLI.

### When to Update Snapshots

Update snapshots when:

- You intentionally change the MediaWiki output format
- You add new features that change the generated content
- You fix bugs that affect the output

**Never update snapshots without reviewing the changes first!**

## Test Cache

The e2e tests use a test cache (`--newCache test-cache`) that provides sample data for testing. This ensures tests are deterministic and don't depend on external cache files.

## File Structure

```
e2e/
├── __snapshots__/          # Jest snapshots
│   └── pages.e2e.ts.snap  # Snapshot file for pages tests
├── utils/                  # Test utilities
│   └── cli.ts             # CLI testing utilities
├── cli.e2e.ts             # CLI functionality tests
├── pages.e2e.ts           # Pages command tests
├── jest.config.js         # Jest configuration for e2e tests
└── README.md              # This file
```

## Example Test Output

When tests run successfully, they validate:

1. **File creation**:

   - `./out/pages/item/1.txt`
   - `./out/pages/item/named/Toolkit.txt`

2. **Content validation**:

   ```
   {{New Content}}
   {{Infobox Item
   |name = Toolkit
   |image = [[File:Toolkit.png]]
   |members = Yes
   ...
   ```

3. **Snapshot matching**: Content matches the stored snapshot exactly

## Adding New Tests

To add new e2e tests:

1. Create a new test file in the `e2e/` directory
2. Use the utilities in `utils/cli.ts` for running commands
3. Follow the existing patterns for file validation and snapshot testing
4. Run tests with `-u` flag to generate initial snapshots
5. Review and commit the snapshots

Example:

```typescript
it("should generate music page", async () => {
  const result = await runCLICommand({
    command: "npm run start",
    args: [
      "pages",
      "--",
      "--newCache",
      "test-cache",
      "--id",
      "5154",
      "--type",
      "music",
    ],
    expectedOutputFile: "./out/pages/music/5154.txt",
  });

  expect(result.exitCode).toBe(0);
  expect(result.outputContent).toMatchSnapshot("music-5154-output.txt");
});
```
